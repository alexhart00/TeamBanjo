{"version":3,"file":"upload.js","sourceRoot":"","sources":["../../../../src/cli/services/deploy/upload.ts"],"names":[],"mappings":"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","sourcesContent":["import {ReqDeployConfig, UploadDeploymentResponse} from './types.js'\nimport {\n  CreateDeploymentResponse,\n  CreateDeploymentQuerySchema,\n  CreateDeploymentQuery,\n} from './graphql/create_deployment.js'\nimport {UploadDeploymentQuery} from './graphql/upload_deployment.js'\nimport {zip} from '@shopify/cli-kit/node/archiver'\nimport {ClientError} from 'graphql-request'\nimport {uploadOxygenDeploymentFile, oxygenRequest} from '@shopify/cli-kit/node/api/oxygen'\nimport {inTemporaryDirectory, createFileReadStream} from '@shopify/cli-kit/node/fs'\nimport {fetch, formData} from '@shopify/cli-kit/node/http'\nimport {AbortError} from '@shopify/cli-kit/node/error'\n\nexport const createDeployment = async (config: ReqDeployConfig): Promise<CreateDeploymentResponse> => {\n  const variables = {\n    input: {\n      branch: config.commitRef,\n      commitHash: config.commitSha,\n      commitAuthor: config.commitAuthor,\n      commitMessage: config.commitMessage,\n      commitTimestamp: config.timestamp,\n    },\n  }\n\n  try {\n    const response: CreateDeploymentQuerySchema = await oxygenRequest(\n      config.oxygenAddress,\n      CreateDeploymentQuery,\n      config.deploymentToken,\n      variables,\n    )\n\n    if (response.createDeployment?.error) {\n      if (response.createDeployment.error.unrecoverable) {\n        throw new AbortError(`Unrecoverable: ${response.createDeployment.error.debugInfo}`)\n      }\n\n      throw new AbortError(`Failed to create deployment. ${response.createDeployment.error.debugInfo}`)\n    }\n\n    return response.createDeployment\n  } catch (error) {\n    if (error instanceof ClientError) {\n      if (error.response.status === 429) {\n        throw new AbortError(\"You've made too many requests. Please try again later\")\n      }\n    }\n\n    throw error\n  }\n}\n\nexport const uploadDeployment = async (config: ReqDeployConfig, deploymentID: string): Promise<string> => {\n  let deploymentData: UploadDeploymentResponse | undefined\n\n  await inTemporaryDirectory(async (tmpDir) => {\n    const distPath = config.pathToBuild ? config.pathToBuild : `${config.path}/dist`\n    const distZipPath = `${tmpDir}/dist.zip`\n    await zip({\n      inputDirectory: distPath,\n      outputZipPath: distZipPath,\n    })\n\n    const form = formData()\n    form.append('operations', buildOperationsString(deploymentID))\n    form.append('map', JSON.stringify({'0': ['variables.file']}))\n    form.append('0', createFileReadStream(distZipPath), {filename: distZipPath})\n\n    const response = await uploadOxygenDeploymentFile(config.oxygenAddress, config.deploymentToken, form)\n    if (!response.ok) {\n      if (response.status === 429) {\n        throw new AbortError(\"You've made too many requests. Please try again later\")\n      }\n      if (response.status !== 200 && response.status !== 202) {\n        throw new AbortError(`Failed to upload deployment. ${await response.json()}`)\n      }\n    }\n\n    deploymentData = (await response.json()) as UploadDeploymentResponse\n  })\n\n  if (!deploymentData) {\n    throw new AbortError('Failed to upload deployment.')\n  }\n  const deploymentError = deploymentData.data?.uploadDeployment?.error\n  if (deploymentError) {\n    if (deploymentError.unrecoverable) {\n      throw new AbortError(`Unrecoverable: ${deploymentError.debugInfo}`)\n    }\n\n    throw new AbortError(`Failed to upload deployment: ${deploymentError.debugInfo}`)\n  }\n\n  return deploymentData.data.uploadDeployment.deployment.previewURL\n}\n\nexport const healthCheck = async (pingUrl: string) => {\n  const url = `${pingUrl}/__health`\n  const result = await fetch(url, {method: 'GET'})\n  if (result.status !== 200) throw new AbortError('Web page not available.')\n}\n\nconst buildOperationsString = (deploymentID: string): string => {\n  return JSON.stringify({\n    query: UploadDeploymentQuery,\n    variables: {deploymentID, file: null},\n  })\n}\n"]}