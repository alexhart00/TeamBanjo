{"version":3,"file":"preview.js","sourceRoot":"","sources":["../../../src/cli/services/preview.ts"],"names":[],"mappings":"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","sourcesContent":["import {readAndParseDotEnv, DotEnvFile} from '@shopify/cli-kit/node/dot-env'\nimport {fileExists, removeFileSync, writeFile, findPathUp} from '@shopify/cli-kit/node/fs'\nimport {exec} from '@shopify/cli-kit/node/system'\nimport {resolvePath, dirname} from '@shopify/cli-kit/node/path'\nimport {BugError} from '@shopify/cli-kit/node/error'\nimport {outputInfo, outputContent, outputToken} from '@shopify/cli-kit/node/output'\nimport {fileURLToPath} from 'url'\n\ninterface PreviewOptions {\n  directory: string\n  port: number\n}\n\ninterface PreviewOptionsWorker extends PreviewOptions {\n  envPath: string | undefined\n}\n\ninterface EnvConfig {\n  env: DotEnvFile['variables']\n}\n\nexport async function previewInNode({directory, port}: PreviewOptions) {\n  const buildOutputPath = await resolvePath(directory, 'dist/node')\n\n  if (!(await fileExists(buildOutputPath))) {\n    outputInfo(\n      outputContent`Couldnâ€™t find a Node.js server build for this project. Running ${outputToken.packagejsonScript(\n        'yarn',\n        'shopify hydrogen build',\n        '--target=node',\n      )} to create one.`,\n    )\n\n    await exec('yarn', ['shopify', 'hydrogen', 'build', '--target=node'], {\n      cwd: directory,\n      stdout: process.stdout,\n      stderr: process.stderr,\n    })\n  }\n\n  await exec('node', ['--enable-source-maps', buildOutputPath], {\n    env: {PORT: `${port}`},\n    cwd: directory,\n    stdout: process.stdout,\n    stderr: process.stderr,\n  })\n}\n\nexport async function previewInWorker({directory, port, envPath}: PreviewOptionsWorker) {\n  const config = {\n    port,\n    workerFile: 'dist/worker/index.js',\n    assetsDir: 'dist/client',\n    buildCommand: 'yarn build',\n    modules: true,\n    watch: true,\n    buildWatchPaths: ['./src'],\n    autoReload: true,\n    ...(envPath && (await parseEnvPath(envPath))),\n  }\n\n  await writeFile(resolvePath(directory, 'mini-oxygen.config.json'), JSON.stringify(config, null, 2))\n\n  function cleanUp(options: {exit: boolean}) {\n    if (options.exit) {\n      removeFileSync(resolvePath(directory, 'mini-oxygen.config.json'))\n    }\n  }\n\n  async function parseEnvPath(envPath: string): Promise<EnvConfig> {\n    const {variables} = await readAndParseDotEnv(envPath)\n    return {\n      env: variables,\n    }\n  }\n\n  process.on('SIGINT', cleanUp.bind(null, {exit: true}))\n\n  const executable = await oxygenPreviewExecutable()\n\n  await exec(executable, [], {\n    env: {NODE_OPTIONS: '--experimental-vm-modules'},\n    cwd: directory,\n    stdout: process.stdout,\n    stderr: process.stderr,\n  })\n}\n\nexport const OxygenPreviewExecutableNotFound = new BugError(\n  'Could not locate the executable file to run Oxygen locally.',\n)\n\nasync function oxygenPreviewExecutable(): Promise<string> {\n  const cwd = dirname(fileURLToPath(import.meta.url))\n  const executablePath = await findPathUp('node_modules/.bin/oxygen-preview', {\n    type: 'file',\n    cwd,\n    allowSymlinks: true,\n  })\n  if (!executablePath) {\n    throw OxygenPreviewExecutableNotFound\n  }\n  return executablePath\n}\n"]}